#!/usr/bin/env sh
. "$(dirname "$0")/_/husky.sh"

echo "🔍 Running Pre-commit checks for Laravel + Vite project..."

# 1️⃣ Ensure dependencies are available
if [ ! -d "node_modules" ]; then
  echo "⚠️ Skipping JS checks (no node_modules found)"
else
  # 2️⃣ Auto-format JS, CSS, and Vue files
  "npx" prettier --write "resources/js" "resources/views"

  # 3️⃣ Lint JS files
  "npx" eslint --max-warnings=0 "resources/js" || (echo "❌ Fix lint errors before committing" && exit 1)
fi

# 4️⃣ Run Laravel tests if artisan exists
if [ -f "artisan" ]; then
  echo "🧪 Running Laravel tests..."
  php artisan test --stop-on-failure || (echo "❌ Laravel tests failed. Fix before committing." && exit 1)
else
  echo "⚠️ No artisan file found — skipping Laravel tests"
fi

# 5️⃣ Scan for secrets using ggshield
if command -v ggshield >/dev/null 2>&1; then
  echo "🕵️ Running ggshield secret scan (including .env)..."
  ggshield secret scan pre-commit --staged || (echo "❌ Secret detected! Remove or ignore before committing." && exit 1)
else
  echo "⚠️ ggshield not found — skipping secret scan"
fi

# 6️⃣ Optional: verify that .env file isn't being committed
if git diff --cached --name-only | grep -q "\.env"; then
  echo "🚨 .env file detected in commit! Remove it before committing."
  exit 1
fi

echo "✅ All checks passed. Proceeding with commit..."
